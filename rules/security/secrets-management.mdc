---
description: Secrets management standards for secure handling of API keys, credentials, tokens, and sensitive configuration. This rule covers environment variable usage, secrets scanning, key rotation, and secure storage patterns. Agents must never commit secrets to version control, use environment variables for all sensitive values, implement secrets scanning in CI/CD, and follow encryption standards for stored secrets.
version: 1.0.0
created: 12-08-2025
lastUpdated: 12-08-2025 10:00:00 EST
alwaysApply: true
globs:
type: Security Rule - Secrets management
applicability: All files handling sensitive data
dependencies: []
relatedCommands: [[audit-security.md]]
relatedRules: [[authentication.mdc], [../git/git-commit-messages.mdc]]
relatedStandards: [[security/secrets-handling.md]]
---

# Secrets Management Rule

## When This Rule Applies

This rule **always applies** when working with:
- API keys and tokens
- Database credentials
- OAuth secrets
- Encryption keys
- Any sensitive configuration

---

## Core Principles

1. **Never commit secrets** - Zero tolerance for secrets in version control
2. **Environment variables** - All secrets via env vars
3. **Least access** - Minimize who/what has access to secrets
4. **Rotate regularly** - Plan for key rotation

---

## Secret Types and Handling

### 1. Environment Variables

**Always use environment variables for secrets:**

```typescript
// Good: Environment variable
const apiKey = process.env.API_KEY;
if (!apiKey) {
  throw new Error('API_KEY environment variable is required');
}

// Bad: Hardcoded secret
const apiKey = 'sk_live_abc123'; // NEVER DO THIS
```

### 2. Required Files

**Every project must have:**
- `.env.example` - Template with placeholder values
- `.gitignore` - Must include `.env*` patterns

```bash
# .env.example
DATABASE_URL=postgresql://user:password@localhost:5432/db
API_KEY=your_api_key_here
JWT_SECRET=generate_secure_random_string

# .gitignore
.env
.env.local
.env.*.local
*.pem
*.key
```

### 3. Secret Patterns to Detect

**Pre-commit scanning should catch:**

```regex
# Common secret patterns
sk_live_[a-zA-Z0-9]{24}       # Stripe live key
sk_test_[a-zA-Z0-9]{24}       # Stripe test key
ghp_[a-zA-Z0-9]{36}           # GitHub personal token
gho_[a-zA-Z0-9]{36}           # GitHub OAuth token
AIza[a-zA-Z0-9_-]{35}         # Google API key
AKIA[A-Z0-9]{16}              # AWS access key
password\s*=\s*['"][^'"]+['"] # Password assignments
```

### 4. Secure Secret Loading

```typescript
// Good: Validated secret loading
function loadSecrets(): Secrets {
  const required = ['DATABASE_URL', 'JWT_SECRET', 'API_KEY'];
  const missing = required.filter((key) => !process.env[key]);
  
  if (missing.length > 0) {
    throw new Error(`Missing required secrets: ${missing.join(', ')}`);
  }
  
  return {
    databaseUrl: process.env.DATABASE_URL!,
    jwtSecret: process.env.JWT_SECRET!,
    apiKey: process.env.API_KEY!,
  };
}
```

---

## Storage Guidelines

### Local Development
- Use `.env.local` for local overrides
- Never use production secrets locally
- Use separate credentials for development

### Production
- Use cloud secret managers (AWS Secrets Manager, GCP Secret Manager, Vault)
- Enable encryption at rest
- Implement access logging
- Use service accounts with minimal permissions

### CI/CD
- Use GitHub Secrets, GitLab CI variables, or similar
- Never echo/print secrets in logs
- Mask sensitive values in output

---

## Pre-Commit Scanning

**Implement secrets scanning in git hooks:**

```bash
# .husky/pre-commit
#!/bin/sh

# Scan for secrets
if git diff --cached | grep -iE "sk_live|ghp_|password\s*=|api_key\s*=" | grep -v "^---\|^+++\|^-"; then
  echo "❌ Potential secrets detected in staged files"
  echo "Remove secrets before committing"
  exit 1
fi
```

---

## Key Rotation

**Plan for rotation:**
1. Support multiple active keys during rotation
2. Log key usage for audit
3. Document rotation procedure
4. Test rotation in staging first

```typescript
// Support multiple keys during rotation
const validApiKeys = [
  process.env.API_KEY_CURRENT,
  process.env.API_KEY_PREVIOUS, // Still valid during rotation
].filter(Boolean);

function validateApiKey(key: string): boolean {
  return validApiKeys.includes(key);
}
```

---

## Anti-Patterns to Avoid

- ❌ Secrets in code comments
- ❌ Secrets in error messages or logs
- ❌ Secrets in URL parameters
- ❌ Shared secrets across environments
- ❌ Secrets in Docker images
- ❌ Secrets in client-side code
- ❌ Committing `.env` files

---

## Security Checklist

- [ ] All secrets in environment variables
- [ ] `.env.example` exists with placeholders
- [ ] `.env*` patterns in `.gitignore`
- [ ] Pre-commit secrets scanning enabled
- [ ] No secrets in code, comments, or logs
- [ ] Different credentials per environment
- [ ] Secrets validated on startup
- [ ] Key rotation plan documented

---

## Related Files

- **Rules:**
  - [authentication.mdc](./authentication.mdc) - Secure credential handling
  - [../git/git-commit-messages.mdc](../git/git-commit-messages.mdc) - Pre-commit scanning
- **Commands:**
  - [audit-security.md](../../commands/audit-security.md) - Security audit including secrets
